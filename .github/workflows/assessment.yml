name: Run AgentBeats Assessment

on:
  push:
    branches: [ main ]
    paths:
      - 'scenario.toml'
  workflow_dispatch:
    inputs:
      num_tasks:
        description: 'Number of tasks to run'
        required: false
        default: '10'

permissions:
  contents: write
  pull-requests: write
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  build-images:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build and push Green Agent
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.green
        push: true
        tags: ${{ env.REGISTRY }}/${{ github.repository_owner }}/a2a-swe-bench-green:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Build and push Purple Agent
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.purple
        push: true
        tags: ${{ env.REGISTRY }}/${{ github.repository_owner }}/a2a-swe-bench-purple:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  run-assessment:
    needs: build-images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Create directories
      run: |
        mkdir -p output results
        
    - name: Generate Docker Compose
      run: |
        python generate_compose.py --scenario scenario.toml
        echo "=== Generated docker-compose.yml ==="
        cat docker-compose.yml
        
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Pull images
      run: |
        docker pull ${{ env.REGISTRY }}/${{ github.repository_owner }}/a2a-swe-bench-green:latest || true
        docker pull ${{ env.REGISTRY }}/${{ github.repository_owner }}/a2a-swe-bench-purple:latest || true
        
    - name: Run Assessment
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        docker compose up --abort-on-container-exit || echo "Assessment completed or failed"
      timeout-minutes: 30
      continue-on-error: true
        
    - name: Collect Results
      if: always()
      run: |
        mkdir -p leaderboard/results
        cp -r output/* leaderboard/results/ 2>/dev/null || echo "No output files to copy"
        echo "=== Results ==="
        ls -la leaderboard/results/
        
    - name: Create sample result if empty
      if: always()
      run: |
        if ! ls leaderboard/results/*.json 1>/dev/null 2>&1; then
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          cat > leaderboard/results/run_${{ github.run_id }}.json << EOF
        {
          "participants": {
            "agent": "019bbec8-5656-7792-b572-21fcf6cc36fb"
          },
          "id": "019bbec8-5656-7792-b572-21fcf6cc36fb",
          "score": 0,
          "accuracy": 0,
          "timestamp": "${TIMESTAMP}",
          "run_id": "${{ github.run_id }}",
          "status": "workflow_completed"
        }
        EOF
        fi
        ls -la leaderboard/results/
        
    - name: Upload Results Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: assessment-results-${{ github.run_id }}
        path: leaderboard/results/
        if-no-files-found: warn
        
    - name: Commit results to repo
      if: always()
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add leaderboard/results/
        git diff --staged --quiet || git commit -m "Add assessment results from run #${{ github.run_id }}"
        git push || echo "Push failed or nothing to push"
